.MODEL TINY
.DATA

P 	EQU		08CH
A 	EQU		088H
S 	EQU		092H
F 	EQU		08EH
I 	EQU		09FH
L 	EQU		0C7H

.CODE
.STARTUP

; LOAD THE ADDRESSES OF CS DS ES

START:	MOV AL,90H			;SET MODE PA-INPUT
		OUT 56H,AL
BACK:	IN AL,50H			;READ PORT A
		CMP AL,00H
		JZ BACK
		CMP AL,01H			;CHECK FOR 6116
		JNZ RAM2
RAM1:	MOV SI,7FFH			;MAX ADDRESS FOR 6116
		JMP TEST
RAM2:	MOV SI,7FFFH		;MAX ADDRESS FOR 6164

;TESTING

TEST:	MOV BH,00H		;USED FOR WRITING ZEROES
		MOV BL,01H		;USED FOR WRITING ONES
		MOV DX,00H		;INDICATES PRESENT ADDRESS
REPEAT1:MOV AH,08H 		; FOR A BYTE
REPEAT:	MOV CH,BH		;WRITING AND READING ZERO
		CALL WRITE
		CALL READ
		AND AL,BL		;TO GET THE SPECIFIC BIT
		CMP AL,CH		;CHECK WITH WRITTEN VALUE
		JNZ FAILED
		
		MOV CH,BL		;WRITING AND READING ONE
		CALL WRITE
		CALL READ
		AND AL,BL
		CMP AL,BL		; SHOULDN'T YOU COMPARE WITH CH?
		JNZ FAILED

		ROL BL,1
		DEC AH
		JNZ REPEAT		;REPEATING FOR BITS OF A BYTE
		
		INC DX		;NEXT ADDRESS
		CMP DX,SI		;REACHED LAST ADDRESS
		JNZ REPEAT1

;OUTPUT

PASSED:	CALL DISP1
		;JMP START		;REPEAT TILL ANOTHER RAM
FAILED:	;MOV DX,0080H	;MOVING TO CODE OF FAILED
		;MOV DS,DX
		;MOV DX,06H
		CALL DISP2
		;JMP START		;GOTO THE BEGINNING
;-------------------------------------------------------------
DISP1 PROC NEAR
		
		MOV AL,90H		;SET MODE
		OUT 50H,AL
		MOV AL,00H
		OUT 52H,AL		;MAKE ALL THE OUTPUTS ZERO

		;ENABLE 1 DISABLE OTHERS
YO2:		MOV AL,11111110B
		OUT 54H,AL
		;DISPLAY P
		MOV AL,P ; CHECK THIS
		OUT 52H,AL

		MOV AL,11111101B
		OUT 54H,AL
		;DISPLAY A
		MOV AL,A ; CHECK THIS
		OUT 52H,AL

		MOV AL,11111011B
		OUT 54H,AL
		;DISPLAY S
		MOV AL,S ; CHECK THIS
		OUT 52H,AL

		MOV AL,11110111B
		OUT 54H,AL
		;DISPLAY S
		MOV AL,S ; CHECK THIS
		OUT 52H,AL

		
		JMP YO2
		RET
;-------------------------------------------------------------
DISP2 PROC NEAR
		
		MOV AL,90H		;SET MODE
		OUT 50H,AL
		MOV AL,00H
		OUT 52H,AL		;MAKE ALL THE OUTPUTS ZERO

		;ENABLE 1 DISABLE OTHERS
YO:		MOV AL,11111110B
		OUT 54H,AL
		;DISPLAY F
		MOV AL,F ; CHECK THIS
		OUT 52H,AL

		MOV AL,11111101B
		OUT 54H,AL
		;DISPLAY A
		MOV AL,A ; CHECK THIS
		OUT 52H,AL

		MOV AL,11111011B
		OUT 54H,AL
		;DISPLAY L
		MOV AL,L ; CHECK THIS
		OUT 52H,AL

		MOV AL,11110111B
		OUT 54H,AL
		;DISPLAY L
		MOV AL,L ; CHECK THIS
		OUT 52H,AL

		JMP YO
		RET

;-------------------------------------------------------------
DELAY PROC NEAR
	
	PUSH CX
	MOV CL,88h
	X1:NOP		;INTRODUCE DELAY
	NOP
	LOOP X1
	POP CX
	RET
;-------------------------------------------------------------

READ PROC NEAR
		
	MOV AL,90H
	OUT 86H,AL		;SET THE READING MODE
	
	MOV AL,01110000b
	OUT 54H,AL		;DESELECT THE CHIP
	
	; PLACE THE ADDRESS ON THE BUS

	MOV AL,DL		;SET A0-A7
	OUT 82H,AL
	MOV AL,DH		;SET A8-A10
	;MOV CL,03H		;NEED ADDRESS FROM PC3-PC7
	;SHL AL,CL
	;OR AL,00000111b	;MASK THE RD,WR AND CS
	OUT 84H,AL

	;MOV AL,00H		;SET CS
	;OUT 86H,AL

	;MOV AL,04H
	;OUT 86H,AL		;SET RD
	
	; PLACE THE DATA ON THE DATA LINES
	MOV AL,40H
	OUT 54H,AL
	; READ THE DATA
	IN AL,80H
	
	CALL DELAY

	;MOV AL,05H
	;OUT 86H,AL		;RESET RD

	RET
;-------------------------------------------------------------
		
WRITE PROC NEAR

	MOV AL,80H		;SET MODE
	OUT 86H,AL

	;MOV AL,00000111b	;RESET THE CS, RD AND WR 
	;OUT 84H,AL
	MOV AL,01110000B 	; RESET ALL THE PORTS IN 1ST 8255
	OUT 54H,AL
	
	; DX HAS THE WHOLE ADDRESS

	; PUT ALL THE ADDRESS ON PORT B AND C
	MOV AL,DL		;MOVE A0-A7
	OUT 82H,AL
	MOV AL,DH
	;MOV CL,03H		;GET THE A8-A14 LINES
	;SHL AL,CL
	;OR AL,00000111b
	OUT 84H,AL

	; PUT THE DATA ON PORT A

	MOV AL,CH		;GET DATA TO BE WRITTEN
	OUT 80H,AL		;PUT DATA ON PORT A
	
	
	;MOV AL,00H 					; I DONT THINK THIS LINE IS REQUIRED
	;OUT 86H,AL		;SET CS 	; I DONT THINK THIS LINE IS REQUIRED
		
	; GIVE THE WRITE SIGNAL TO THE RAM ALONG WITH CHIP SELECT

	MOV AL,20H
	OUT 54H,AL


	;MOV AL,03H		;RESET WR
	;OUT AL,03H		; THIS SEEMS TOTALY WRONG. YOU SHOLD WRITE THIS TO PORT C AT 
	
	CALL DELAY	
	
	RET

.EXIT
END